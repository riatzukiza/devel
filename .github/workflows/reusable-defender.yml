name: reusable-defender

on:
  workflow_call:
    inputs:
      checkout-submodules:
        description: "Checkout submodules recursively"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  defender:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: ${{ inputs.checkout-submodules && 'recursive' || 'false' }}

      - name: Validate detection with EICAR
        shell: pwsh
        run: |
          $eicar = "X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
          $path = "$env:TEMP\eicar.com.txt"
          Set-Content -Path $path -Value $eicar -Encoding ASCII
          $mpc = "$Env:ProgramFiles\Windows Defender\MpCmdRun.exe"
          if (!(Test-Path $mpc)) { $mpc = "$Env:ProgramFiles\Microsoft Defender\MpCmdRun.exe" }
          if (!(Test-Path $mpc)) { Write-Error "MpCmdRun.exe not found"; exit 1 }
          & $mpc -Scan -ScanType 3 -File $path
          $rc = $LASTEXITCODE
          Remove-Item $path -Force
          if ($rc -eq 2) {
            Write-Output "EICAR detected as expected"
          } elseif ($rc -eq 0) {
            Write-Error "EICAR was not detected by Defender"
            exit 1
          } else {
            Write-Error "Defender scan exited with code $rc"
            exit $rc
          }

      - name: Scan repository
        shell: pwsh
        run: |
          $mpc = "$Env:ProgramFiles\Windows Defender\MpCmdRun.exe"
          if (!(Test-Path $mpc)) { $mpc = "$Env:ProgramFiles\Microsoft Defender\MpCmdRun.exe" }
          if (!(Test-Path $mpc)) { Write-Error "MpCmdRun.exe not found"; exit 1 }
          & $mpc -Scan -ScanType 3 -File "$PWD"
          $rc = $LASTEXITCODE
          if ($rc -ne 0) {
            Write-Error "Defender detected issues (exit code $rc)"
            exit $rc
          }
