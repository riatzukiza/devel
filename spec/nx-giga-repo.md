---
uuid: e758e1dc-837a-4b8a-97d6-760d51ea00eb
title: "Nx Orchestration for Giga Repo (Design Spec)"
slug: nx-giga-repo
status: incoming
priority: P2
tags: []
created_at: "2026-02-03T06:36:00.408448Z"
estimates:
  complexity: ''
  scale: ''
  time_to_completion: ''
storyPoints: null
---
# Nx Orchestration for Giga Repo (Design Spec)

Goal: Establish a root-level Nx-driven orchestration that watches file changes across the entire giga repo (including git submodules), runs tests/build for only affected projects, and automatically commits/tag-propagates submodule updates up the hierarchy with structured, Pantheon-generated commit messages.

## Context

- Root repo contains multiple git submodules under `orgs/`.
- `orgs/riatzukiza/promethean` already uses Nx (nx.json present).
- Root currently has no Nx. We'll add a light Nx wrapper (non-invasive) that treats each submodule as a project and delegates to the submodule's own tooling.

## Requirements

- Watcher runs locally, on file changes:
  - Compute which submodule(s) the changed file belongs to.
  - Run targeted tasks:
    - If submodule has Nx: run submodule `nx affected --targets test,build --files <changed>`.
    - Else: run `pnpm test`/`pnpm build` where scripts exist; otherwise no-op.
  - Persist a per-action status (success/failure) for tagging and commit messages.
- Commit propagation:
  - If a submodule produces changes (build outputs, version bumps, codegen, etc.), commit in that submodule with a Pantheon-generated message.
  - Tag that commit with: `giga/v<version>/<action>/<result>/<id>`.
  - Update the parent (superproject) submodule pointer automatically:
    - Stage the submodule path in the parent.
    - Aggregate upstream messages (include child message as "cause").
    - Commit and tag in the parent with same structured tag pattern.
  - Repeat recursively up to root.
- Commit message content:
  - Generated by Pantheon (pluggable hook). If Pantheon CLI not present, fallback summarizer uses staged diff, action, result, and affected file list.
- Auto-increment id:
  - Per-repo monotonic id derived from `.git/refs/tags/giga/*` or `.git/giga-id` fallback.
- Non-destructive by default:
  - No pushing to remotes unless explicitly enabled.

## Out of Scope (Phase 1)

- CI integration (e.g., GitHub Actions) beyond local scripts.
- Nx custom project-graph plugin (can be Phase 3 if needed).
- Automatic version bumping; we only read version if available (e.g., package.json) for tagging.

## Phases

### Phase 1: Watch + Delegate + Commit Propagation (Local)
- Add Bun-based watcher `src/giga/giga-watch.ts`.
- Add commit/tag propagation utilities `src/giga/commit-propagator.ts`.
- Add Pantheon generator stub `src/giga/pantheon.ts`.
- Add CLI wrappers in `bin/` and package.json scripts.
- Provide `.githooks/` samples and an installer script (optional).

### Phase 2: Nx Wrapper (Root)
- Add minimal `nx.json` to the root so we can use `nx run giga:watch` style commands.
- Optionally define synthetic projects for submodules that proxy to their native commands (`nx:run-commands`).

### Phase 3: Nx Project-Graph Plugin (Optional Enhancement)
- Implement an Nx plugin under `tools/nx-plugins/giga` to:
  - Read `.gitmodules` and emit project nodes per submodule.
  - Declare implicit deps (e.g., root -> all submodules).
  - Provide `test` and `build` targets per node that delegate to the repo's own tooling.

## Definition of Done

- `pnpm run giga:watch` starts a watcher that:
  - Detects changes under `orgs/**` and routes to the correct repo.
  - Runs tests/build only for the affected submodule (and internally, affected projects when Nx is available).
  - On changes produced, makes local commits with structured tags and Pantheon-generated messages (or fallback), and updates parent pointers up to root.
- Tags created match `giga/v<version>/<action>/<result>/<id>`.
- No pushes happen by default; can be enabled via `GIGA_PUSH=1` env var.
- Minimal Nx scaffolding at root exists; future plugin optional.

## Repo Map (selected)
- Root: nx (to add), watcher + git utilities
- orgs/riatzukiza/promethean: Nx monorepo (existing)
- orgs/sst/opencode: Web & frontend
- orgs/... (others vary; many not using Nx)

## Existing Issues / PRs
- None searched in this spec (local only). CI integration and plugin work targeted for future phases.

## Quickstart
- Install deps (root): `pnpm i` (required for Nx CLI at root)
- Optional: set Pantheon CLI program: `export PANTHEON_CLI="pantheon-gen --json"`.
- Start watcher from root: `pnpm run giga:watch`.
  - On file changes under `orgs/**`, it will run affected tests/build.
  - On produced changes, it will commit and tag in the submodule, then update and tag the parent recursively.
- Tags follow: `giga/v<version>/<action>/<result>/<id>`.
- Enable pushing tags/commits: `GIGA_PUSH=1 pnpm run giga:watch` (disabled by default).
- Manual propagation: `pnpm run giga:commit <subRepoPath> watch success <file1> <file2> ...`.

### Nx Wrapper (Phase 2)
- Generate Nx projects: `pnpm run giga:nx:generate` (re-run when submodules change)
- List projects (after install): `pnpm nx show projects`
- Run watcher via Nx: `pnpm nx run giga:watch`
- Run submodule tests via Nx: `pnpm nx run orgs-riatzukiza-promethean:test` (proxies to the submodule)
- Run submodule build via Nx: `pnpm nx run orgs-riatzukiza-promethean:build`
